<div class="step" style="font-family: Arial, sans-serif;">
  <h2>Start Your Design</h2>
  <label for="customerName" style="display: block; margin-bottom: 10px; font-size: 16px;">Your Name:</label>
  <input type="text" id="customerName" placeholder="Enter your name" style="width: 100%; padding: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 5px;" />

  <label for="customerEmail" style="display: block; margin-bottom: 10px; font-size: 16px;">Your Email:</label>
  <input type="email" id="customerEmail" placeholder="Enter your email address" style="width: 100%; padding: 10px; margin-bottom: 30px; border: 1px solid #ccc; border-radius: 5px;" />
</div>

<div class="step" style="font-family: Arial, sans-serif;">
  <h2>Step 1: What is this for?</h2>
  <label style="margin-bottom: 10px; display: flex; align-items: center; font-size: 16px;"><input type="checkbox" style="margin-right: 10px;" name="purpose" value="Retirement">Retirement</label>
  <label style="margin-bottom: 10px; display: flex; align-items: center; font-size: 16px;"><input type="checkbox" style="margin-right: 10px;" name="purpose" value="Memorial">Memorial</label>
  <label style="margin-bottom: 10px; display: flex; align-items: center; font-size: 16px;"><input type="checkbox" style="margin-right: 10px;" name="purpose" value="Gift / Celebration">Gift / Celebration</label>
  <label style="margin-bottom: 10px; display: flex; align-items: center; font-size: 16px;"><input type="checkbox" style="margin-right: 10px;" name="purpose" value="Something Special">Something Special</label>
</div>

<div class="step" style="font-family: Arial, sans-serif;">
  <h2>Step 2: What's the message?</h2>
  <label for="recipientName">Recipient or Theme:</label>
  <input type="text" id="recipientName" placeholder="e.g., MAJ Richard Satchels" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px;" />

  <label for="mainMessage">Main Message or Quote:</label>
  <textarea id="mainMessage" rows="4" placeholder="e.g., Thank you for your faithful service..." style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px;"></textarea>

  <label for="aiHelp">Want help creating the perfect message? Let Sasha assist:</label>
  <textarea id="aiHelp" rows="3" placeholder="e.g., A few details you'd like included..." style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px;"></textarea>
</div>

<div class="step" style="font-family: Arial, sans-serif;">
  <h2>Step 3: Choose Your Style (Check all that apply)</h2>
  <label><input type="checkbox" name="style" value="Layered Wood"> Layered Wood</label><br>
  <label><input type="checkbox" name="style" value="Acrylic"> Acrylic</label><br>
  <label><input type="checkbox" name="style" value="Metal (Coming Soon)"> Metal (Coming Soon)</label><br>
  <label><input type="checkbox" name="style" value="Painted"> Painted</label><br>
  <label for="symbols">Symbols or Logos (optional):</label>
  <input type="file" id="symbols" accept="image/*" />
</div>

<div class="step" style="font-family: Arial, sans-serif;">
  <h2>Optional: Upload Additional Files</h2>
  <label style="font-weight: normal;">
    If you'd like to share sketches, logos, or reference images, you can upload them here. These will be matched to your design form and reviewed during our creative process.
  </label>
  <div style="border: 2px dashed #ccc; padding: 20px; border-radius: 10px; margin-top: 15px; background: #fafafa;">
    <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSflt4Pg8rKNEH20TvUQ71AFu2rBbgMFcDoP23AbH6FhHAPqWw/viewform?embedded=true" width="100%" height="600" frameborder="0" style="border: none; width: 100%; max-width: 100%;" allowfullscreen></iframe>
    <p style="font-size: 12px; color: #777; margin-top: 10px;">
      Please include your full name or email in the form so we can connect the upload with your design request.
    </p>
  </div>
</div>

<div class="step" style="font-family: Arial, sans-serif;">
  <h2>Step 4: AI Preview</h2>
  <p style="margin-bottom: 10px; font-weight: bold;">Click the button below to generate a preview based on your message or theme.</p>
  <button onclick="generatePreview()" style="padding: 10px 20px; background-color: #003366; color: white; border: none; border-radius: 5px; cursor: pointer;">üîç Generate Preview</button>
  <div id="previewResult" style="margin-top: 20px; text-align: center;"></div>
</div>

<div class="step" style="font-family: Arial, sans-serif;">
  <h2>Finalize Your Request</h2>
  <p style="margin-bottom: 10px;">When you're ready, click below to send your design request to the Honor Works team.</p>
  <div style="text-align: center;">
    <button onclick="submitForm()" style="padding: 12px 25px; font-size: 16px; background-color: #003366; color: white; border: none; border-radius: 8px; cursor: pointer;">‚úÖ Submit Design Request</button>
  </div>
</div>

<script>
const style = document.createElement('style');
style.innerHTML = `
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
`;
document.head.appendChild(style);

let latestImageUrl = "";

async function generatePreview() {
  const recipient = document.getElementById("recipientName")?.value || "Service Member";
  const message = document.getElementById("mainMessage")?.value || "Thank you for your service.";
  const purposes = [...document.querySelectorAll('input[name="purpose"]:checked')].map(cb => cb.value).join(', ');
  const styles = [...document.querySelectorAll('input[name="style"]:checked')].map(cb => cb.value).join(', ');

  const prompt = `Create a ${styles || 'layered wood'} design for a ${purposes || 'military'} theme honoring ${recipient}. Include the message: '${message}'.`;

  const resultContainer = document.getElementById("previewResult");
  if (resultContainer) {
    resultContainer.innerHTML = `
      <p>Generating preview...</p>
      <div class="loader" style="margin: 20px auto; border: 5px solid #ccc; border-top: 5px solid #003366; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
    `;
  }

  try {
    const response = await fetch("https://honor-ai-backend.onrender.com/api/generate-image", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt })
    });

    const data = await response.json();
    if (data.imageUrl && resultContainer) {
      latestImageUrl = data.imageUrl;
      resultContainer.innerHTML = `
        <img src="${data.imageUrl}" alt="Preview Image" style="max-width: 100%; border-radius: 10px; box-shadow: 0 0 8px rgba(0,0,0,0.2); margin-top: 10px;" />
        <p style="margin-top: 10px;">
          <button onclick="generatePreview()" style="padding: 8px 16px; background-color: #555; color: white; border: none; border-radius: 5px; cursor: pointer;">üîÅ Regenerate</button>
        </p>
        <p style="color: green; font-weight: bold; margin-top: 10px;">Preview generated successfully!</p>
      `;
    } else if (resultContainer) {
      resultContainer.innerHTML = "<p style='color:red;'>Failed to generate image.</p>";
    }
  } catch (error) {
    console.error("Error generating preview:", error);
    if (resultContainer) {
      resultContainer.innerHTML = "<p style='color:red;'>An error occurred while generating the preview.</p>";
    }
  }
}

async function submitForm() {
  const data = {
    customerName: document.getElementById("customerName")?.value || "",
    customerEmail: document.getElementById("customerEmail")?.value || "",
    purpose: [...document.querySelectorAll('input[name="purpose"]:checked')].map(cb => cb.value).join(', '),
    recipient: document.getElementById("recipientName")?.value || "",
    message: document.getElementById("mainMessage")?.value || "",
    aiHelp: document.getElementById("aiHelp")?.value || "",
    style: [...document.querySelectorAll('input[name="style"]:checked')].map(cb => cb.value).join(', '),
    notes: document.getElementById("extraNotes")?.value || "",
    imageUrl: latestImageUrl || "No preview generated"
  };

  try {
    const response = await fetch("https://script.google.com/macros/s/AKfycbxuGGPZNUkj1aiLkEMpr8p8zA0L0vBbu23K_dGnR5LXk4c-3lWJHIz5x93GFbaweY2-/exec", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });

    const result = await response.json();
    if (result.success) {
      alert("‚úÖ Design request submitted successfully!");
    } else {
      alert("‚ùå Failed to send. Please try again.");
    }
  } catch (error) {
    console.error("Form submission error:", error);
    alert("An unexpected error occurred.");
  }
}
</script>
